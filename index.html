<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Zona De Desestr√©s</title>
    <!-- Carga Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga Tone.js para generaci√≥n de audio -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        /* Estilos base y fuentes */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* Fondo oscuro */
            color: #f8fafc; /* Texto claro */
            min-height: 100vh;
        }
        .container-box {
            background-color: #1e293b; /* Fondo de las tarjetas de juego */
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            min-height: 60vh;
        }
        .btn-desestres {
            transition: all 0.2s ease;
            box-shadow: 0 4px 10px rgba(139, 92, 246, 0.3);
        }
        .btn-desestres:hover:not(:disabled) {
            transform: translateY(-1px);
            opacity: 0.95;
        }
        
        /* Estilos para Burbujas */
        .bubble {
            width: 30px;
            height: 30px;
            background-color: #4f46e5;
            border-radius: 50%;
            cursor: pointer;
            position: absolute;
            transition: transform 0.1s;
            box-shadow: 0 0 10px rgba(79, 70, 229, 0.5);
        }
        
        /* Estilos para Respiraci√≥n Guiada */
        #breathing-circle {
            width: 150px;
            height: 150px;
            background-color: #8b5cf6;
            border-radius: 50%;
            margin: 0 auto;
            animation: breathe 16s ease-in-out infinite; /* 4s in, 7s hold, 5s out = 16s */
            box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.7);
        }
        @keyframes breathe {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.7);
                opacity: 0.8;
            }
            25% { /* Inhale 4s */
                transform: scale(1.5);
                box-shadow: 0 0 0 20px rgba(139, 92, 246, 0);
                opacity: 1;
            }
            43.75% { /* Hold 7s -> 25% + (7/16)*100 = 68.75% */
                transform: scale(1.5);
                opacity: 1;
            }
            68.75% { /* Exhale 5s */
                transform: scale(1);
                opacity: 0.8;
            }
        }
        
        /* Estilos para Lienzo Zen y Borrado de Preocupaciones */
        #zen-canvas, #wave-canvas, #symmetry-canvas {
            border-radius: 0.5rem;
            cursor: crosshair;
            background-color: #334155; /* Slate-700 */
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-6xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-violet-400 mb-2">Pankicakes: La Zona De Desestr√©s</h1>
            <p class="text-violet-300 text-lg">10 actividades para calmar la mente y mejorar el enfoque.</p>
        </header>

        <!-- Navegaci√≥n de Actividades (Tabs) -->
        <nav class="mb-8 border-b border-slate-700">
            <div id="activity-tabs" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-2 -mb-px text-xs sm:text-sm font-medium">
                <button data-activity="bubbles" class="px-2 py-2 text-violet-300 border-b-2 border-transparent hover:text-violet-400 hover:border-violet-400 active-tab transition duration-300 text-center truncate">1. Burbujas</button>
                <button data-activity="breathing" class="px-2 py-2 text-slate-300 border-b-2 border-transparent hover:text-violet-400 hover:border-violet-400 transition duration-300 text-center truncate">2. Respiraci√≥n</button>
                <button data-activity="zen_canvas" class="px-2 py-2 text-slate-300 border-b-2 border-transparent hover:text-violet-400 hover:border-violet-400 transition duration-300 text-center truncate">3. Lienzo Zen</button>
                <button data-activity="noise" class="px-2 py-2 text-slate-300 border-b-2 border-transparent hover:text-violet-400 hover:border-violet-400 transition duration-300 text-center truncate">4. Ruido Blanco</button>
                <button data-activity="pomodoro" class="px-2 py-2 text-slate-300 border-b-2 border-transparent hover:text-violet-400 hover:border-violet-400 transition duration-300 text-center truncate">5. Enfoque (Pomodoro)</button>
                <button data-activity="eraser" class="px-2 py-2 text-slate-300 border-b-2 border-transparent hover:text-violet-400 hover:border-violet-400 transition duration-300 text-center truncate">6. Borrar Preocupaciones</button>
                <button data-activity="gratitude" class="px-2 py-2 text-slate-300 border-b-2 border-transparent hover:text-violet-400 hover:border-violet-400 transition duration-300 text-center truncate">7. Diario de Gratitud</button>
                <button data-activity="wave" class="px-2 py-2 text-slate-300 border-b-2 border-transparent hover:text-violet-400 hover:border-violet-400 transition duration-300 text-center truncate">8. Visualizador de Ondas</button>
                <button data-activity="memory" class="px-2 py-2 text-slate-300 border-b-2 border-transparent hover:text-violet-400 hover:border-violet-400 transition duration-300 text-center truncate">9. Concentraci√≥n (Memoria)</button>
                <button data-activity="symmetry" class="px-2 py-2 text-slate-300 border-b-2 border-transparent hover:text-violet-400 hover:border-violet-400 transition duration-300 text-center truncate">10. Dibujo Sim√©trico</button>
            </div>
        </nav>

        <!-- Contenedor de Actividades -->
        <div id="activity-container" class="container-box p-4 sm:p-8">
            <!-- Las actividades se cargar√°n aqu√≠ -->
        </div>
    </div>

    <!-- Script principal de JavaScript -->
    <script>
        let currentActivity = 'bubbles'; 
        const activityContainer = document.getElementById('activity-container');
        const activityTabs = document.getElementById('activity-tabs');
        
        // Variables globales de estado y recursos
        let noisePlayer = null;
        let pomodoroInterval = null;
        let waveRAF = null; // Para requestAnimationFrame de Wave
        let symmetryCtx = null;
        let symmetryIsDrawing = false;
        let breathingAnimationStarted = false;

        // =======================================================
        // L√≥gica de Limpieza y Control
        // =======================================================

        function cleanupPreviousActivity() {
            // 1. Limpiar Audio (Tone.js)
            if (noisePlayer) {
                noisePlayer.stop();
                noisePlayer.dispose();
                noisePlayer = null;
                // [FIX] Se elimin√≥ Tone.context.close() para evitar el InvalidStateError al reanudar el contexto.
            }

            // 2. Limpiar Intervalos (Pomodoro)
            if (pomodoroInterval) {
                clearInterval(pomodoroInterval);
                pomodoroInterval = null;
                // Reiniciar estado de pomodoro si existe
                if (window.pomodoroState) {
                    window.pomodoroState.isRunning = false;
                    window.pomodoroState.isBreak = false;
                }
            }
            
            // 3. Limpiar Animaciones (Wave Visualizer)
            if (waveRAF) {
                cancelAnimationFrame(waveRAF);
                waveRAF = null;
            }

            // 4. Limpiar Animaci√≥n de Respiraci√≥n
            const circle = document.getElementById('breathing-circle');
            if (circle) {
                circle.style.animationPlayState = 'paused';
            }
            
            // 5. Limpiar Eventos de Dibujo
            // [FIX] Se elimin√≥ el bucle de limpieza de canvas que causaba ReferenceError: handleSymmetryStart is not defined.
            // Al sobrescribir activityContainer.innerHTML, los elementos de canvas y sus listeners se eliminan autom√°ticamente.

            // 6. Limpiar Grid de Memoria (no requiere limpieza expl√≠cita de listeners aqu√≠)
        }

        // =======================================================
        // L√≥gica de Navegaci√≥n
        // =======================================================

        const activityTemplates = {
            'bubbles': renderBubbles,
            'breathing': renderBreathing,
            'zen_canvas': renderZenCanvas,
            'noise': renderNoise,
            'pomodoro': renderPomodoro,
            'eraser': renderEraser,
            'gratitude': renderGratitude,
            'wave': renderWave,
            'memory': renderMemory,
            'symmetry': renderSymmetry
        };

        function switchActivity(activityName) {
            cleanupPreviousActivity(); 

            currentActivity = activityName;
            activityContainer.innerHTML = activityTemplates[activityName]();
            
            // Inicializar la l√≥gica espec√≠fica de la actividad
            if (activityName === 'bubbles') initializeBubbles();
            if (activityName === 'breathing') initializeBreathing();
            if (activityName === 'zen_canvas') initializeZenCanvas();
            if (activityName === 'noise') initializeNoise();
            if (activityName === 'pomodoro') initializePomodoro();
            if (activityName === 'eraser') initializeEraser();
            if (activityName === 'gratitude') initializeGratitude();
            if (activityName === 'wave') initializeWave();
            if (activityName === 'memory') initializeMemory();
            if (activityName === 'symmetry') initializeSymmetry();

            // Actualizar el estilo de las pesta√±as
            document.querySelectorAll('#activity-tabs button').forEach(button => {
                if (button.getAttribute('data-activity') === activityName) {
                    button.classList.remove('text-slate-300');
                    button.classList.add('text-violet-300', 'border-violet-400');
                } else {
                    button.classList.add('text-slate-300');
                    button.classList.remove('text-violet-300', 'border-violet-400');
                }
            });
        }

        activityTabs.addEventListener('click', (e) => {
            const activityName = e.target.getAttribute('data-activity');
            if (activityName && activityName !== currentActivity) {
                switchActivity(activityName);
            }
        });

        // =======================================================
        // 1. Pulsar Burbujas (Bubble Popper)
        // =======================================================

        function renderBubbles() {
            return `
                <div id="bubbles-area" class="w-full h-80 relative rounded-xl bg-slate-800 p-4 overflow-hidden">
                    <h3 class="text-xl font-semibold mb-2 text-violet-300">1. Pulsar Burbujas</h3>
                    <p class="text-sm text-gray-400 mb-4">Haz clic para generar y reventar burbujas. ¬°Satisfactorio y liberador!</p>
                </div>
            `;
        }

        function initializeBubbles() {
            const area = document.getElementById('bubbles-area');
            if (!area) return;

            area.addEventListener('click', (e) => {
                // Crear una nueva burbuja
                const bubble = document.createElement('div');
                bubble.classList.add('bubble');
                bubble.style.left = `${e.clientX - area.getBoundingClientRect().left - 15}px`;
                bubble.style.top = `${e.clientY - area.getBoundingClientRect().top - 15}px`;
                area.appendChild(bubble);

                // Funci√≥n para reventar
                bubble.onclick = () => {
                    bubble.style.transform = 'scale(1.5)';
                    bubble.style.opacity = '0';
                    setTimeout(() => {
                        bubble.remove();
                    }, 150);
                };

                // Desvanecer despu√©s de un tiempo si no se revienta
                setTimeout(() => {
                    if (bubble.parentNode) {
                        bubble.style.opacity = '0';
                        setTimeout(() => bubble.remove(), 1000);
                    }
                }, 3000);
            });
        }

        // =======================================================
        // 2. Respiraci√≥n Guiada (Breathing Guide)
        // =======================================================
        
        function renderBreathing() {
            return `
                <div class="max-w-md mx-auto text-center">
                    <h3 class="text-xl font-semibold mb-4 text-violet-300">2. Respiraci√≥n Guiada (T√©cnica 4-7-8)</h3>
                    <p class="text-sm text-gray-400 mb-6">Inhala 4s, Sost√©n 7s, Exhala 5s. Sigue el c√≠rculo.</p>
                    
                    <div id="breathing-circle-container" class="relative w-40 h-40 mx-auto mb-8 flex items-center justify-center">
                        <div id="breathing-circle" class="absolute"></div>
                        <span id="breathing-text" class="relative text-lg font-bold text-white">INICIAR</span>
                    </div>
                    
                    <button id="breathing-toggle" class="btn-desestres bg-violet-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-violet-700">
                        INICIAR
                    </button>
                </div>
            `;
        }
        
        function initializeBreathing() {
            const circle = document.getElementById('breathing-circle');
            const text = document.getElementById('breathing-text');
            const toggleBtn = document.getElementById('breathing-toggle');
            
            let isRunning = false;
            
            const phases = [
                { name: 'INHALAR (4s)', duration: 4000, color: 'text-green-300' },
                { name: 'SOSTENER (7s)', duration: 7000, color: 'text-yellow-300' },
                { name: 'EXHALAR (5s)', duration: 5000, color: 'text-red-300' }
            ];
            
            function updateBreathingText(phase) {
                text.textContent = phase.name;
                text.className = `relative text-lg font-bold ${phase.color}`;
            }

            function animateBreathing() {
                if (!isRunning) return;

                let index = 0;
                
                function runPhase() {
                    const phase = phases[index % phases.length];
                    updateBreathingText(phase);
                    
                    setTimeout(() => {
                        if (isRunning) {
                            index++;
                            runPhase();
                        }
                    }, phase.duration);
                }

                runPhase();
            }

            toggleBtn.onclick = () => {
                isRunning = !isRunning;
                if (isRunning) {
                    toggleBtn.textContent = 'PAUSAR';
                    circle.style.animationPlayState = 'running';
                    animateBreathing();
                } else {
                    toggleBtn.textContent = 'REANUDAR';
                    circle.style.animationPlayState = 'paused';
                    text.textContent = 'PAUSADO';
                    text.className = 'relative text-lg font-bold text-yellow-500';
                }
            };
            
            // Estado inicial: pausar la animaci√≥n hasta que el usuario pulse INICIAR
            circle.style.animationPlayState = 'paused';
            text.textContent = 'INICIAR';
        }

        // =======================================================
        // 3. Lienzo Zen (Zen Canvas)
        // =======================================================

        function renderZenCanvas() {
            return `
                <div class="w-full text-center">
                    <h3 class="text-xl font-semibold mb-4 text-violet-300">3. Lienzo Zen (Dibujo Libre)</h3>
                    <p class="text-sm text-gray-400 mb-4">Garabatea suavemente. No hay objetivos, solo movimiento.</p>
                    <canvas id="zen-canvas" class="w-full h-80"></canvas>
                    <button id="zen-clear" class="btn-desestres mt-4 bg-red-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-red-700">
                        Limpiar
                    </button>
                </div>
            `;
        }

        function initializeZenCanvas() {
            const canvas = document.getElementById('zen-canvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            let isDrawing = false;

            // Hacer el canvas responsivo
            function resizeCanvas() {
                const rect = canvas.parentNode.getBoundingClientRect();
                canvas.width = rect.width;
                canvas.height = 320; // Altura fija
                ctx.lineWidth = 3;
                ctx.strokeStyle = '#a78bfa'; /* Violet-400 */
                ctx.lineCap = 'round';
            }
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();

            function startDrawing(e) {
                isDrawing = true;
                draw(e);
            }

            function stopDrawing() {
                isDrawing = false;
                ctx.beginPath(); // Finalizar el camino actual
            }

            function draw(e) {
                if (!isDrawing) return;
                
                // Obtener coordenadas relativas
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                ctx.lineTo(x, y);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(x, y);
            }

            // Eventos de rat√≥n
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mousemove', draw);
            
            // Eventos t√°ctiles
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                startDrawing(e.touches[0]);
            });
            canvas.addEventListener('touchend', stopDrawing);
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                draw(e.touches[0]);
            });

            // Bot√≥n de limpiar
            document.getElementById('zen-clear').onclick = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            };
        }

        // =======================================================
        // 4. Generador de Ruido Blanco (White Noise)
        // =======================================================

        function renderNoise() {
            return `
                <div class="max-w-md mx-auto text-center">
                    <h3 class="text-xl font-semibold mb-4 text-violet-300">4. Generador de Ruido (Sound Masking)</h3>
                    <p class="text-sm text-gray-400 mb-6">Usa ruido constante para bloquear distracciones y calmar la mente.</p>
                    
                    <div class="flex justify-center space-x-4 mb-8">
                        <button data-type="white" class="btn-desestres noise-btn bg-violet-600 text-white py-2 px-4 rounded-xl hover:bg-violet-700">Blanco</button>
                        <button data-type="pink" class="btn-desestres noise-btn bg-violet-600 text-white py-2 px-4 rounded-xl hover:bg-violet-700">Rosa</button>
                        <button data-type="brown" class="btn-desestres noise-btn bg-violet-600 text-white py-2 px-4 rounded-xl hover:bg-violet-700">Marr√≥n</button>
                    </div>

                    <div class="mb-4">
                        <label for="noise-volume" class="block text-md font-medium mb-2">Volumen</label>
                        <input type="range" id="noise-volume" min="0" max="1" step="0.01" value="0.5" class="w-full">
                    </div>
                    
                    <button id="noise-toggle" class="btn-desestres bg-red-600 text-white font-bold py-2 px-8 rounded-xl hover:bg-red-700">
                        DETENER SONIDO
                    </button>
                </div>
            `;
        }

        function initializeNoise() {
            const toggleBtn = document.getElementById('noise-toggle');
            const volumeSlider = document.getElementById('noise-volume');
            const noiseButtons = document.querySelectorAll('.noise-btn');
            
            // Inicializar el contexto de audio al interactuar
            document.body.addEventListener('click', () => {
                if (Tone.context.state !== 'running') {
                    Tone.start();
                }
            }, { once: true });

            function startNoise(type) {
                cleanupPreviousActivity(); // Asegurar que el anterior Tone.js se limpie

                // El jugador solo se crea si el contexto de audio est√° disponible
                if (Tone.context.state !== 'running') {
                    Tone.start();
                }

                // Generador de ruido
                noisePlayer = new Tone.Noise(type).start();
                
                // Conectar al destino con control de volumen
                const gain = new Tone.Gain(volumeSlider.value).toDestination();
                noisePlayer.connect(gain);
                
                // Actualizar UI
                toggleBtn.textContent = 'DETENER SONIDO';
                toggleBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                toggleBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                
                noiseButtons.forEach(btn => {
                    if (btn.dataset.type === type) {
                        btn.classList.add('bg-opacity-100');
                        btn.classList.remove('bg-opacity-50');
                    } else {
                        btn.classList.add('bg-opacity-50');
                        btn.classList.remove('bg-opacity-100');
                    }
                });
            }

            toggleBtn.onclick = () => {
                if (noisePlayer) {
                    cleanupPreviousActivity();
                    toggleBtn.textContent = 'INICIAR';
                    toggleBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                    toggleBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                    noiseButtons.forEach(btn => btn.classList.remove('bg-opacity-100'));
                } else {
                    // Por defecto, inicia el ruido blanco
                    startNoise('white'); 
                }
            };
            
            volumeSlider.oninput = (e) => {
                if (noisePlayer && noisePlayer.context.destination.input) {
                    // Asumiendo que el GainNode es el destino
                    // Es necesario acceder al GainNode que se conect√≥ al inicio
                    // Pero como se recrea en startNoise, solo podemos acceder a la ganancia a trav√©s de Tone.Destination si no usamos un GainNode expl√≠cito.
                    // Para simplificar, ajustaremos el valor directamente si es un Tone.Noise conectado al destino.
                    // Nota: En la implementaci√≥n actual con GainNode, esto es una simplificaci√≥n, pero funciona para el volumen general.
                    Tone.Destination.volume.value = Tone.gainToDb(parseFloat(e.target.value));
                }
            };

            noiseButtons.forEach(btn => {
                btn.onclick = () => {
                    startNoise(btn.dataset.type);
                };
            });
            
            // Estado inicial
            noiseButtons.forEach(btn => btn.classList.add('bg-opacity-50'));
            toggleBtn.textContent = 'INICIAR';
            toggleBtn.classList.add('bg-green-600', 'hover:bg-green-700');
            toggleBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
        }

        // =======================================================
        // 5. Contador de Enfoque (Pomodoro simple)
        // =======================================================
        
        let pomodoroState = {
            duration: 25 * 60, // 25 minutos
            timeRemaining: 25 * 60,
            isRunning: false,
            isBreak: false
        };
        window.pomodoroState = pomodoroState; // Exportar para limpieza

        function renderPomodoro() {
            return `
                <div class="max-w-md mx-auto text-center">
                    <h3 class="text-xl font-semibold mb-4 text-violet-300">5. Contador de Enfoque (Pomodoro)</h3>
                    <p class="text-sm text-gray-400 mb-6">25 minutos de enfoque, 5 minutos de descanso. ¬°Conc√©ntrate!</p>
                    
                    <div id="pomodoro-timer" class="text-6xl font-extrabold mb-4 text-green-400">25:00</div>
                    <div id="pomodoro-status" class="text-lg font-medium text-yellow-400 mb-8">Enfoque</div>
                    
                    <div class="flex justify-center space-x-4">
                        <button id="pomodoro-toggle" class="btn-desestres bg-violet-600 text-white font-bold py-3 px-8 rounded-xl hover:bg-violet-700">
                            Iniciar
                        </button>
                        <button id="pomodoro-reset" class="btn-desestres bg-slate-500 text-white font-bold py-3 px-8 rounded-xl hover:bg-slate-600">
                            Reiniciar
                        </button>
                    </div>
                </div>
            `;
        }

        function initializePomodoro() {
            const timerDisplay = document.getElementById('pomodoro-timer');
            const statusDisplay = document.getElementById('pomodoro-status');
            const toggleBtn = document.getElementById('pomodoro-toggle');
            const resetBtn = document.getElementById('pomodoro-reset');
            
            function updateDisplay() {
                const minutes = Math.floor(pomodoroState.timeRemaining / 60).toString().padStart(2, '0');
                const seconds = (pomodoroState.timeRemaining % 60).toString().padStart(2, '0');
                timerDisplay.textContent = `${minutes}:${seconds}`;
            }
            
            function setFocusPhase() {
                pomodoroState.isBreak = false;
                pomodoroState.duration = 25 * 60;
                pomodoroState.timeRemaining = pomodoroState.duration;
                statusDisplay.textContent = 'Enfoque';
                timerDisplay.classList.remove('text-blue-400');
                timerDisplay.classList.add('text-green-400');
                updateDisplay();
            }

            function setBreakPhase() {
                pomodoroState.isBreak = true;
                pomodoroState.duration = 5 * 60;
                pomodoroState.timeRemaining = pomodoroState.duration;
                statusDisplay.textContent = 'Descanso';
                timerDisplay.classList.remove('text-green-400');
                timerDisplay.classList.add('text-blue-400');
                updateDisplay();
                // Simular una alerta sin usar window.alert
                const statusDiv = document.getElementById('pomodoro-status');
                statusDiv.innerHTML = '¬°TERMIN√ì! Cambiando de fase...';
                setTimeout(() => statusDiv.innerHTML = pomodoroState.isBreak ? 'Descanso' : 'Enfoque', 3000);
            }

            function togglePomodoro() {
                if (!pomodoroState.isRunning) {
                    pomodoroState.isRunning = true;
                    toggleBtn.textContent = 'Pausar';
                    pomodoroInterval = setInterval(() => {
                        pomodoroState.timeRemaining--;
                        updateDisplay();
                        
                        if (pomodoroState.timeRemaining <= 0) {
                            clearInterval(pomodoroInterval);
                            pomodoroState.isRunning = false;
                            toggleBtn.textContent = 'Iniciar';
                            
                            if (pomodoroState.isBreak) {
                                setFocusPhase();
                            } else {
                                setBreakPhase();
                            }
                            // Reiniciar autom√°ticamente el contador despu√©s de cambiar de fase
                            setTimeout(togglePomodoro, 100); // Peque√±o retraso para asegurar el estado correcto
                        }
                    }, 1000);
                } else {
                    pomodoroState.isRunning = false;
                    toggleBtn.textContent = 'Reanudar';
                    clearInterval(pomodoroInterval);
                }
            }

            function resetPomodoro() {
                clearInterval(pomodoroInterval);
                pomodoroState.isRunning = false;
                toggleBtn.textContent = 'Iniciar';
                setFocusPhase();
            }
            
            toggleBtn.onclick = togglePomodoro;
            resetBtn.onclick = resetPomodoro;
            
            // Inicializaci√≥n
            setFocusPhase();
        }

        // =======================================================
        // 6. Borrado de Preocupaciones (Focus Eraser)
        // =======================================================

        let worryIdCounter = 0;

        function renderEraser() {
            return `
                <div class="max-w-xl mx-auto">
                    <h3 class="text-xl font-semibold mb-4 text-violet-300">6. Borrado de Preocupaciones</h3>
                    <p class="text-sm text-gray-400 mb-4">Escribe una preocupaci√≥n, haz clic en ella para borrarla y liberar espacio mental.</p>
                    
                    <div class="flex space-x-2 mb-6">
                        <input type="text" id="worry-input" placeholder="Escribe algo que te preocupe..." maxlength="60" 
                               class="flex-grow p-3 bg-slate-600 border border-slate-500 rounded-lg text-white focus:ring-violet-500 focus:border-violet-500">
                        <button id="worry-add" class="btn-desestres bg-violet-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-violet-700">
                            A√±adir
                        </button>
                    </div>

                    <div id="worry-list" class="p-4 bg-slate-700 rounded-xl min-h-[100px] flex flex-wrap gap-3 content-start">
                        <!-- Las preocupaciones se mostrar√°n aqu√≠ -->
                        <p class="text-gray-400 text-sm italic w-full text-center" id="worry-placeholder">Tu espacio mental est√° limpio.</p>
                    </div>
                </div>
            `;
        }

        function initializeEraser() {
            const input = document.getElementById('worry-input');
            const addBtn = document.getElementById('worry-add');
            const list = document.getElementById('worry-list');
            const placeholder = document.getElementById('worry-placeholder');

            function updatePlaceholder() {
                 placeholder.classList.toggle('hidden', list.children.length > (placeholder ? 1 : 0));
            }
            
            function addWorry() {
                const text = input.value.trim();
                if (text === "") return;

                const id = worryIdCounter++;
                const worryElement = document.createElement('div');
                worryElement.id = `worry-${id}`;
                worryElement.className = 'worry-tag bg-red-400 text-slate-900 font-semibold px-3 py-1 rounded-full shadow-md cursor-pointer hover:bg-red-500 transform transition duration-200';
                worryElement.textContent = text;
                
                worryElement.onclick = function() {
                    // Animaci√≥n de borrado
                    worryElement.style.opacity = '0';
                    worryElement.style.transform = 'scale(0.8)';
                    setTimeout(() => {
                        worryElement.remove();
                        updatePlaceholder();
                    }, 300);
                };

                list.appendChild(worryElement);
                input.value = '';
                updatePlaceholder();
            }

            addBtn.onclick = addWorry;
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addWorry();
            });
            
            updatePlaceholder(); // Inicializar el placeholder
        }

        // =======================================================
        // 7. Diario R√°pido de Gratitud
        // =======================================================

        function renderGratitude() {
            return `
                <div class="max-w-xl mx-auto">
                    <h3 class="text-xl font-semibold mb-4 text-violet-300">7. Diario R√°pido de Gratitud</h3>
                    <p class="text-sm text-gray-400 mb-4">Escribe 3 cosas por las que est√°s agradecido hoy. Enfocarse en lo positivo ayuda a la calma.</p>
                    
                    <div class="mb-4">
                        <textarea id="gratitude-input" rows="5" placeholder="Hoy estoy agradecido por..."
                                  class="w-full p-3 bg-slate-600 border border-slate-500 rounded-lg text-white focus:ring-violet-500 focus:border-violet-500"></textarea>
                    </div>
                    
                    <button id="gratitude-save" class="btn-desestres bg-green-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-green-700">
                        Guardar Entrada
                    </button>
                    <p id="gratitude-status" class="mt-3 text-sm text-green-400"></p>

                    <h4 class="text-lg font-semibold mt-8 mb-3 text-violet-300">Entradas Anteriores</h4>
                    <div id="gratitude-history" class="p-4 bg-slate-700 rounded-xl max-h-60 overflow-y-auto">
                        <p class="text-gray-400 text-sm italic" id="history-placeholder">A√∫n no hay entradas guardadas.</p>
                    </div>
                </div>
            `;
        }

        function initializeGratitude() {
            const input = document.getElementById('gratitude-input');
            const saveBtn = document.getElementById('gratitude-save');
            const historyDiv = document.getElementById('gratitude-history');
            const statusDiv = document.getElementById('gratitude-status');
            const placeholder = document.getElementById('history-placeholder');

            function getEntries() {
                try {
                    return JSON.parse(localStorage.getItem('gratitudeEntries')) || [];
                } catch (e) {
                    console.error("Error al parsear entradas de gratitud:", e);
                    return [];
                }
            }

            function saveEntries(entries) {
                localStorage.setItem('gratitudeEntries', JSON.stringify(entries));
            }
            
            function renderHistory() {
                const entries = getEntries();
                historyDiv.innerHTML = ''; 

                if (entries.length === 0) {
                    historyDiv.appendChild(placeholder);
                    placeholder.classList.remove('hidden');
                    return;
                }
                
                placeholder.classList.add('hidden');

                entries.forEach(entry => {
                    const entryDiv = document.createElement('div');
                    entryDiv.className = 'border-b border-slate-600 pb-2 mb-2 last:border-b-0';
                    entryDiv.innerHTML = `
                        <p class="text-xs text-violet-400">${new Date(entry.timestamp).toLocaleDateString()}</p>
                        <p class="text-sm">${entry.text}</p>
                    `;
                    historyDiv.prepend(entryDiv);
                });
            }

            saveBtn.onclick = () => {
                const text = input.value.trim();
                if (text === "") {
                    statusDiv.textContent = 'Por favor, escribe algo antes de guardar.';
                    statusDiv.classList.remove('text-green-400');
                    statusDiv.classList.add('text-red-400');
                    return;
                }
                
                const entries = getEntries();
                entries.push({ text: text, timestamp: new Date().toISOString() });
                saveEntries(entries);
                
                input.value = '';
                statusDiv.textContent = '¬°Entrada de gratitud guardada con √©xito!';
                statusDiv.classList.remove('text-red-400');
                statusDiv.classList.add('text-green-400');

                renderHistory();
                setTimeout(() => statusDiv.textContent = '', 3000);
            };

            renderHistory();
        }

        // =======================================================
        // 8. Visualizador de Ondas (Wave Visualizer)
        // =======================================================

        function renderWave() {
            return `
                <div class="w-full text-center">
                    <h3 class="text-xl font-semibold mb-4 text-violet-300">8. Visualizador de Ondas (Calma Visual)</h3>
                    <p class="text-sm text-gray-400 mb-4">Observa el movimiento suave y repetitivo de las ondas para relajar la vista.</p>
                    <canvas id="wave-canvas" class="w-full h-80"></canvas>
                </div>
            `;
        }
        
        function initializeWave() {
            const canvas = document.getElementById('wave-canvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            let time = 0;

            function resizeCanvas() {
                const rect = canvas.parentNode.getBoundingClientRect();
                canvas.width = rect.width;
                canvas.height = 320;
            }
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();

            function drawWave() {
                // Asegurar que el contexto y el canvas sigan existiendo
                if (!canvas.parentNode) {
                    cancelAnimationFrame(waveRAF);
                    return;
                }

                ctx.clearRect(0, 0, canvas.width, canvas.height);
                const width = canvas.width;
                const height = canvas.height;
                const centerH = height / 2;
                
                for (let i = 0; i < 3; i++) { // Dibujar 3 ondas con diferentes offsets
                    ctx.beginPath();
                    ctx.moveTo(0, centerH);
                    
                    // Configuraci√≥n de onda
                    const amplitude = 30 + i * 15;
                    const frequency = 0.005 + i * 0.002;
                    const offset = time * (0.05 + i * 0.02);
                    
                    ctx.strokeStyle = `rgba(167, 139, 250, ${0.4 - i * 0.1})`; /* Violet-400 con transparencia */
                    ctx.lineWidth = 2;

                    for (let x = 0; x < width; x++) {
                        const y = centerH + amplitude * Math.sin(x * frequency + offset);
                        ctx.lineTo(x, y);
                    }
                    ctx.stroke();
                }

                time++;
                waveRAF = requestAnimationFrame(drawWave);
            }

            drawWave();
        }

        // =======================================================
        // 9. Juego de Memoria (Concentraci√≥n)
        // =======================================================
        
        const MEMORY_ICONS = ['üß†', 'üßò‚Äç‚ôÄÔ∏è', 'üå∏', '‚òï', 'üìö', 'üåô', 'üå≤', '‚ú®'];
        let memoryBoard = [];
        let flippedCards = [];
        let matchesFound = 0;
        let isWaiting = false;

        function renderMemory() {
            return `
                <div class="max-w-xl mx-auto text-center">
                    <h3 class="text-xl font-semibold mb-4 text-violet-300">9. Concentraci√≥n (Juego de Memoria)</h3>
                    <p class="text-sm text-gray-400 mb-4">Empareja los √≠conos para mejorar tu enfoque y memoria de trabajo.</p>
                    
                    <div id="memory-grid" class="grid grid-cols-4 gap-3 bg-slate-700 p-4 rounded-xl">
                        <!-- Tarjetas de memoria -->
                    </div>

                    <p id="memory-status" class="mt-4 text-lg font-semibold text-yellow-400">Juego en curso...</p>
                    <button id="memory-restart" class="btn-desestres bg-red-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-red-700 mt-4">
                        Reiniciar
                    </button>
                </div>
            `;
        }

        function initializeMemory() {
            const grid = document.getElementById('memory-grid');
            const restartBtn = document.getElementById('memory-restart');
            
            function setupBoard() {
                let cards = [...MEMORY_ICONS, ...MEMORY_ICONS];
                // Funci√≥n de Fisher-Yates para mezclar
                for (let i = cards.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [cards[i], cards[j]] = [cards[j], cards[i]];
                }
                memoryBoard = cards;
                flippedCards = [];
                matchesFound = 0;
                isWaiting = false;
                document.getElementById('memory-status').textContent = 'Juego en curso...';
                grid.innerHTML = memoryBoard.map((icon, index) => `
                    <div class="memory-card bg-slate-600 aspect-square rounded-lg flex items-center justify-center text-4xl cursor-pointer shadow-lg hover:bg-slate-500" 
                         data-index="${index}" data-icon="${icon}" data-flipped="false">
                        <!-- Icono oculto -->
                    </div>
                `).join('');
            }
            
            function handleMemoryClick(e) {
                const card = e.target.closest('.memory-card');
                if (!card || isWaiting || card.dataset.flipped === 'true' || flippedCards.length === 2) return;

                card.dataset.flipped = 'true';
                card.textContent = card.dataset.icon;
                card.classList.remove('bg-slate-600', 'hover:bg-slate-500');
                card.classList.add('bg-violet-400');
                flippedCards.push(card);

                if (flippedCards.length === 2) {
                    isWaiting = true;
                    setTimeout(checkMatch, 1000);
                }
            }

            function checkMatch() {
                const [card1, card2] = flippedCards;
                isWaiting = false;

                if (card1.dataset.icon === card2.dataset.icon) {
                    // Coincidencia
                    matchesFound++;
                    card1.classList.add('bg-green-400', 'pointer-events-none');
                    card2.classList.add('bg-green-400', 'pointer-events-none');
                    document.getElementById('memory-status').textContent = `¬°Coincidencia encontrada! (${matchesFound}/${MEMORY_ICONS.length})`;

                    if (matchesFound === MEMORY_ICONS.length) {
                        document.getElementById('memory-status').textContent = '¬°Felicidades! Has ganado. Tu mente est√° enfocada.';
                    }
                } else {
                    // No coincidencia, voltear de nuevo
                    card1.dataset.flipped = 'false';
                    card2.dataset.flipped = 'false';
                    card1.textContent = '';
                    card2.textContent = '';
                    card1.classList.add('bg-slate-600', 'hover:bg-slate-500');
                    card2.classList.add('bg-slate-600', 'hover:bg-slate-500');
                    card1.classList.remove('bg-violet-400');
                    card2.classList.remove('bg-violet-400');
                    document.getElementById('memory-status').textContent = 'Int√©ntalo de nuevo...';
                }
                flippedCards = [];
            }
            
            grid.addEventListener('click', handleMemoryClick);
            restartBtn.onclick = setupBoard;
            
            setupBoard();
        }

        // =======================================================
        // 10. Dibujo de Simetr√≠a
        // =======================================================

        function renderSymmetry() {
            return `
                <div class="w-full text-center">
                    <h3 class="text-xl font-semibold mb-4 text-violet-300">10. Dibujo de Simetr√≠a</h3>
                    <p class="text-sm text-gray-400 mb-4">Dibuja en un lado y se reflejar√° en el otro. Ejercicio de enfoque y equilibrio.</p>
                    <div class="relative w-full">
                        <canvas id="symmetry-canvas" class="w-full h-80"></canvas>
                        <div class="absolute inset-y-0 left-1/2 w-px bg-red-400/50 pointer-events-none"></div>
                    </div>
                    <button id="symmetry-clear" class="btn-desestres mt-4 bg-red-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-red-700">
                        Limpiar
                    </button>
                </div>
            `;
        }

        function initializeSymmetry() {
            const canvas = document.getElementById('symmetry-canvas');
            if (!canvas) return;
            
            const clearBtn = document.getElementById('symmetry-clear');
            symmetryCtx = canvas.getContext('2d');
            
            function resizeCanvas() {
                const rect = canvas.parentNode.getBoundingClientRect();
                canvas.width = rect.width;
                canvas.height = 320;
                symmetryCtx.lineWidth = 4;
                symmetryCtx.strokeStyle = '#a78bfa'; /* Violet-400 */
                symmetryCtx.lineCap = 'round';
            }
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();

            function getRelativePos(e) {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                return { x, y };
            }

            // [FIX] Se definieron las funciones localmente para evitar el ReferenceError 
            // en la funci√≥n de limpieza gen√©rica.

            function handleSymmetryStart(e) {
                symmetryIsDrawing = true;
                const pos = getRelativePos(e);
                symmetryCtx.beginPath();
                symmetryCtx.moveTo(pos.x, pos.y);
            };

            function handleSymmetryDraw(e) {
                if (!symmetryIsDrawing) return;
                
                const pos = getRelativePos(e);
                const centerX = canvas.width / 2;
                
                // Dibujo original
                symmetryCtx.lineTo(pos.x, pos.y);
                symmetryCtx.stroke();
                
                // Reiniciar camino para el reflejo (evitar que se conecten)
                symmetryCtx.beginPath();
                symmetryCtx.moveTo(pos.x, pos.y);

                // Dibujo reflejado (calcular la posici√≥n sim√©trica)
                const reflectedX = centerX + (centerX - pos.x);
                
                symmetryCtx.lineTo(reflectedX, pos.y);
                symmetryCtx.stroke();
                
                // Mover al punto de origen para el siguiente segmento
                symmetryCtx.beginPath();
                symmetryCtx.moveTo(pos.x, pos.y);
            };

            function handleSymmetryEnd() {
                symmetryIsDrawing = false;
                symmetryCtx.beginPath();
            };

            // Eventos de rat√≥n
            canvas.addEventListener('mousedown', handleSymmetryStart);
            canvas.addEventListener('mouseup', handleSymmetryEnd);
            canvas.addEventListener('mousemove', handleSymmetryDraw);
            
            // Eventos t√°ctiles
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                handleSymmetryStart(e.touches[0]);
            });
            canvas.addEventListener('touchend', handleSymmetryEnd);
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                handleSymmetryDraw(e.touches[0]);
            });

            clearBtn.onclick = () => {
                symmetryCtx.clearRect(0, 0, canvas.width, canvas.height);
            };
        }

        // =======================================================
        // Inicializaci√≥n
        // =======================================================

        window.onload = () => switchActivity(currentActivity);

    </script>
</body>
</html>
